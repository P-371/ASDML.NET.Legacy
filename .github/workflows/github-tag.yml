name: GitHub Tag

on:
  pull_request:
    types: [ closed ]
    branches: [ main ]

jobs:
  check:
    name: Get Version and Check Tag
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged

    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
    - uses: actions/checkout@v2
    - name: Get version
      id: get_version
      run: echo '::set-output name=version::`cat ASDML.NET/ASDML.NET.csproj | sed -nE "s/[[:blank:]]*<Version>(.*)<\/Version>[[:blank:]]*/v\1/p"`'
    - name: Checks if tag exists
      run: git tag --list | egrep -q "^${{ steps.get_version.outputs.version }}$" && exit 1 || exit 0
    
  tag:
    name: Create GitHub Tag
    runs-on: ubuntu-latest
    needs: [ check ]
    if: github.event.pull_request.merged

    steps:
    - uses: actions/checkout@v2
    - name: Push tag to GitHub
      uses: laputansoft/github-tag-action@v4.6
      with:
        github_token: $${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ needs.check.outputs.version }}
        default_bump: false
        create_annotated_tag: true
